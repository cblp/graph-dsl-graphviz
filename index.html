<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Downward Edges</title>
    <script src="http://code.jquery.com/jquery-1.12.0.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://marvl.infotech.monash.edu/webcola/cola.v3.min.js"></script>
    <style>
      /*@import url(../style.css);*/

      .node {
        stroke: #fff;
        stroke-width: 1.5px;
      }

      .link {
        fill: none;
        stroke: #000;
        stroke-width: 1.5px;
        opacity: 0.4;
        marker-end: url(#end-arrow);
      }
    </style>
  </head>
  <body>
    <script>
      "use strict";

      const canvasWidth = 960,
            canvasHeight = 500,
            defaultNodeWidth = 60,
            defaultNodeHeight = 50;

      const canvasSize = [canvasWidth, canvasHeight];

      const color = d3.scale.category20();

      const d3cola = cola.d3adaptor()
          .avoidOverlaps(true)
          .size(canvasSize);

      const svg = d3.select("body").append("svg")
          .attr("width", canvasWidth)
          .attr("height", canvasHeight);

      const graph = {
          nodes: [
              {content: "0"},
              {content: "1"},
              {content: "2"},
              {content: "3"},
          ],
          links: [
              {source: 0, target: 1},
              {source: 0, target: 2},
              {source: 1, target: 3},
              {source: 2, target: 3},
          ],
      };

      graph.nodes.forEach(function (v) {
          v.width = v.width || defaultNodeWidth;
          v.height = v.height || defaultNodeHeight;
      });

      d3cola
          .nodes(graph.nodes)
          .links(graph.links)
          .flowLayout(/*axis*/ "x", /*minSeparation*/ 50)
          .symmetricDiffLinkLengths(6)
          .start();

      // define arrow markers for graph links
      svg.append('svg:defs').append('svg:marker')
          .attr('id', 'end-arrow')
          .attr('viewBox', '0 -5 10 10')
          .attr('refX', 6)
          .attr('markerWidth', 3)
          .attr('markerHeight', 3)
          .attr('orient', 'auto')
          .append('svg:path')
              .attr('d', 'M0,-5L10,0L0,5')
              .attr('fill', '#000');

      const path = svg.selectAll(".link")
          .data(graph.links)
          .enter().append('svg:path')
              .attr('class', 'link');

      const node = svg.selectAll(".node")
          .data(graph.nodes)
          .enter().append("rect")
              .attr("class", "node")
              .attr("width", function (d) {return d.width;})
              .attr("height", function (d) {return d.height;})
              .style("fill", function (d) { return color(d.group); })
              .call(d3cola.drag);

      node.append("title")
          .text(function (d) { return d.content; });

      d3cola.on("tick", function () {
          path.each(function (d) {
              if (isIE()) this.parentNode.insertBefore(this, this);
          });
          // draw directed edges with proper padding from node centers
          path.attr('d', function (d) {
              var deltaX = d.target.x - d.source.x,
                  deltaY = d.target.y - d.source.y,
                  dist = Math.sqrt(deltaX * deltaX + deltaY * deltaY),
                  normX = deltaX / dist,
                  normY = deltaY / dist,
                  sourcePadding = Math.max(d.source.width, d.source.height),
                  targetPadding = Math.max(d.target.width, d.target.height) + 2,
                  sourceX = d.source.x + (sourcePadding * normX),
                  sourceY = d.source.y + (sourcePadding * normY),
                  targetX = d.target.x - (targetPadding * normX),
                  targetY = d.target.y - (targetPadding * normY);
              return 'M' + sourceX + ',' + sourceY + 'L' + targetX + ',' + targetY;
          });

          node.attr("x", function (d) { return d.x - d.width / 2; })
              .attr("y", function (d) { return d.y - d.height / 2; });
      });
      // turn on overlap avoidance after first convergence
      //cola.on("end", function () {
      //    if (!cola.avoidOverlaps()) {
      //        graph.nodes.forEach(function (v) {
      //            v.width = v.height = 10;
      //        });
      //        cola.avoidOverlaps(true);
      //        cola.start();
      //    }
      //});

      function isIE() {
          return (
              (navigator.appName == 'Microsoft Internet Explorer')
              ||  ( (navigator.appName == 'Netscape')
                    && (new RegExp("Trident/.*rv:([0-9]{1,}[\.0-9]{0,})").exec(navigator.userAgent) != null)
                  )
          );
      }
    </script>
  </body>
</html>
